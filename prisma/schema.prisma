datasource db {
    provider = "mysql"
    url      = env("DB_URL")
}

generator client {
    provider        = "prisma-client-js"
    previewFeatures = ["fullTextSearch"]
}

model Review {
    id           Int         @id @default(autoincrement())
    createdAt    DateTime    @default(now())
    title        String      @db.VarChar(255)
    text         String
    author       User        @relation(fields: [authorId], references: [id])
    authorId     Int
    category     Category    @relation(fields: [categoryId], references: [id])
    categoryId   Int         @db.SmallInt
    product      Product     @relation(fields: [productId], references: [id])
    productId    Int
    authorsScore Int         @db.SmallInt
    imageUrl     String      @db.VarChar(255) // TODO: optional
    likes        Like[]
    comments     Comment[]
    tags         ReviewTag[]
}

model User {
    id      Int      @id @default(autoincrement())
    nick    String   @unique @db.VarChar(255)
    reviews Review[]
    ratings Rating[]
    likes   Like[]
}

model Category {
    id      Int      @id @default(autoincrement()) @db.SmallInt
    name    String   @db.VarChar(255)
    reviews Review[]
}

model Rating {
    user      User    @relation(fields: [userId], references: [id])
    userId    Int
    product   Product @relation(fields: [productId], references: [id])
    productId Int
    rating    Int     @db.SmallInt

    @@id([userId, productId])
}

model Product {
    id      Int      @id @default(autoincrement())
    name    String   @db.VarChar(255)
    ratings Rating[]
    reviews Review[]
}

model Tag {
    text    String      @id @db.VarChar(255)
    reviews ReviewTag[]
}

model ReviewTag {
    review   Review @relation(fields: [reviewId], references: [id])
    reviewId Int
    tag      Tag    @relation(fields: [tagText], references: [text])
    tagText  String @db.VarChar(255)

    @@id([reviewId, tagText])
}

model Like {
    user     User   @relation(fields: [userId], references: [id])
    userId   Int
    review   Review @relation(fields: [reviewId], references: [id])
    reviewId Int

    @@id([userId, reviewId])
}

model Comment {
    id        Int      @id @default(autoincrement())
    text      String
    review    Review   @relation(fields: [reviewId], references: [id])
    reviewId  Int
    createdAt DateTime @default(now())
}
